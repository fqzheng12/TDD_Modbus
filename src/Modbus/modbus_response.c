#include "modbus.h" 

static const uint16_t* holding_register_map[0x7D] =
{
	REGISTER_0000, REGISTER_0001, REGISTER_0002, REGISTER_0003,
	REGISTER_0004, REGISTER_0005, REGISTER_0006, REGISTER_0007,
	REGISTER_0008, REGISTER_0009, REGISTER_000A, REGISTER_000B,
	REGISTER_000C, REGISTER_000D, REGISTER_000E, REGISTER_000F,	
	REGISTER_0010, REGISTER_0011, REGISTER_0012, REGISTER_0013,
	REGISTER_0014, REGISTER_0015, REGISTER_0016, REGISTER_0017,
	REGISTER_0018, REGISTER_0019, REGISTER_001A, REGISTER_001B,
	REGISTER_001C, REGISTER_001D, REGISTER_001E, REGISTER_001F,	
	REGISTER_0020, REGISTER_0021, REGISTER_0022, REGISTER_0023,
	REGISTER_0024, REGISTER_0025, REGISTER_0026, REGISTER_0027,
	REGISTER_0028, REGISTER_0029, REGISTER_002A, REGISTER_002B,
	REGISTER_002C, REGISTER_002D, REGISTER_002E, REGISTER_002F,	
	REGISTER_0030, REGISTER_0031, REGISTER_0032, REGISTER_0033,
	REGISTER_0034, REGISTER_0035, REGISTER_0036, REGISTER_0037,
	REGISTER_0038, REGISTER_0039, REGISTER_003A, REGISTER_003B,
	REGISTER_003C, REGISTER_003D, REGISTER_003E, REGISTER_003F,	
	REGISTER_0040, REGISTER_0041, REGISTER_0042, REGISTER_0043,
	REGISTER_0044, REGISTER_0045, REGISTER_0046, REGISTER_0047,
	REGISTER_0048, REGISTER_0049, REGISTER_004A, REGISTER_004B,
	REGISTER_004C, REGISTER_004D, REGISTER_004E, REGISTER_004F,	
	REGISTER_0050, REGISTER_0051, REGISTER_0052, REGISTER_0053,
	REGISTER_0054, REGISTER_0055, REGISTER_0056, REGISTER_0057,
	REGISTER_0058, REGISTER_0059, REGISTER_005A, REGISTER_005B,
	REGISTER_005C, REGISTER_005D, REGISTER_005E, REGISTER_005F,	
	REGISTER_0060, REGISTER_0061, REGISTER_0062, REGISTER_0063,
	REGISTER_0064, REGISTER_0065, REGISTER_0066, REGISTER_0067,
	REGISTER_0068, REGISTER_0069, REGISTER_006A, REGISTER_006B,
	REGISTER_006C, REGISTER_006D, REGISTER_006E, REGISTER_006F,	
	REGISTER_0070, REGISTER_0071, REGISTER_0072, REGISTER_0073,
	REGISTER_0074, REGISTER_0075, REGISTER_0076, REGISTER_0077,
	REGISTER_0078, REGISTER_0079, REGISTER_007A, REGISTER_007B,
	REGISTER_007C, 
	
}

uint8_t* modbus_ReadHolding_Response(modbusRequest_ReadInputs_t* request)
{
	uint16_t i;
	uint8_t exceptionCode = 0;
	uint8_t* response;
	
	if(request->input_quantity > 0x7D || request->input_quantity == 0)
	{
		exceptionCode = 3;
	}
	else
	{
		for(i == 0; i < request->input_quantity; i++)
		{
			if(holding_register_map[(request->starting_add + i)] == NULL)
			{
				exceptionCode = 2;
			}
		}
	}
	
	if(exceptionCode == 0)
	{
		response = malloc((request->input_quantity)*2 + 2);
		response[0] = MODBUS_READ_HOLDING_REGISTERS;
		response[1] = (request->input_quantity)*2;	
		
		for(i == 0; i < request->input_quantity; i++)
		{
			uint16_t register_value;
			
			register_value = *(holding_register_map[(request->starting_add + i)]);
			response[2 + 2 * i] = register_value >> 8;
			response[2 + 2 * i + 1] = register_value & 0x00FF;
		}		
	}
	else
	{
		response = malloc(2);
		response[0] = MODBUS_READ_HOLDING_REGISTERS | 0x80;
		response[1] = exceptionCode;
	}
}